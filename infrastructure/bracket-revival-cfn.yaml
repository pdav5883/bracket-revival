Parameters:
  AcmSSLCertificateId:
    Type: String
  SsmAdminSecretId:
    Type: String
  HostedZoneId:
    Type: String
  DeployedRootURL:
    Type: String
  LambdaReadWritePermissionName:
    Type: String
  LambdaPublishPermissionName:
    Type: String
  LambdaReadPermissionName:
    Type: String
  LambdaAdminReadPermissionName:
    Type: String
  PublicBucketName:
    Type: String
  PrivateBucketName:
    Type: String
  LambdaAddElementName:
    Type: String
  LambdaAdminAuthName:
    Type: String
  LambdaAdminEditName:
    Type: String
  LambdaGetBracketName:
    Type: String
  LambdaGetCompetitionsName:
    Type: String
  LambdaGetRoundStartName:
    Type: String
  LambdaGetScoreboardName:
    Type: String
  LambdaSendEmailName:
    Type: String
  LambdaUpdatePicksName:
    Type: String
  LambdaUpdateScoreboardName:
    Type: String
  LayerCommonName:
    Type: String
  SNSTopicEmailName:
    Type: String
  SNSTopicSyncName:
    Type: String
  ApiName:
    Type: String
  PrimaryRouteName:
    Type: String
  AdminRouteName:
    Type: String
Resources:
  LambdaBracketAddElement:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaAddElementName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaAddElementName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketReadWrite.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaAddElement
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketAdminAuth:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaAdminAuthName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaAdminAuthName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketAdminRead.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaAdminAuth
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketAdminEdit:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaAdminEditName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaAdminEditName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketReadWrite.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaAdminEdit
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketGetBracket:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaGetBracketName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaGetBracketName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketRead.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaGetBracket
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketGetCompetitions:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaGetCompetitionsName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaGetCompetitionsName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketRead.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaGetCompetitions
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketGetRoundStart:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaGetRoundStartName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaGetRoundStartName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketRead.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaGetRoundStart
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketGetScoreboard:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaGetScoreboardName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaGetScoreboardName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketRead.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaGetScoreboard
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketSendEmail:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaSendEmailName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaSendEmailName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketRead.Arn
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaSendEmail
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketUpdatePicks:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaUpdatePicksName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaUpdatePicksName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketReadWrite.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaUpdatePicks 
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LambdaBracketUpdateScoreboard:
    Type: "AWS::Lambda::Function"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !Ref LambdaUpdateScoreboardName
      MemorySize: 128
      Description: ""
      TracingConfig:
        Mode: "PassThrough"
      Timeout: 3
      RuntimeManagementConfig:
        UpdateRuntimeOn: "Auto"
      Handler: "lambda_function.lambda_handler"
      Code:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub "lambdas/${LambdaUpdateScoreboardName}.zip"
      Layers:
        - !Ref LayerBracketCommon
      Role: !GetAtt RoleBracketReadWrite.Arn 
      FileSystemConfigs: []
      Runtime: "python3.10"
      PackageType: "Zip"
      LoggingConfig:
        LogFormat: "Text"
        LogGroup: !Ref LogBracketLambdaUpdateScoreboard
      EphemeralStorage:
        Size: 512
      Architectures:
      - "x86_64"
  LayerBracketCommon:
    Type: "AWS::Lambda::LayerVersion"
    Properties:
      LayerName: !Ref LayerCommonName
      Content:
        S3Bucket: !Ref S3BracketPrivate
        S3Key: !Sub lambdas/${LayerCommonName}.zip
      CompatibleRuntimes:
        - "python3.10"
      CompatibleArchitectures:
        - "x86_64"
  SNSTopicBracketEmail:
    Type: "AWS::SNS::Topic"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      TopicName: !Ref SNSTopicEmailName
  SNSSubscriptionBracketEmail:
    Type: "AWS::SNS::Subscription"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      Protocol: "lambda"
      TopicArn: !GetAtt SNSTopicBracketEmail.TopicArn
      Endpoint: !GetAtt LambdaBracketSendEmail.Arn
  SNSTriggerPermissionBracketEmail:
    Type: "AWS::Lambda::Permission"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !GetAtt LambdaBracketSendEmail.Arn
      Action: "lambda:InvokeFunction"
      SourceArn: !GetAtt SNSTopicBracketEmail.TopicArn
      Principal: "sns.amazonaws.com"
  SNSTopicBracketSync:
    Type: "AWS::SNS::Topic"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      TopicName: !Ref SNSTopicSyncName
  SNSSubscriptionBracketSync:
    Type: "AWS::SNS::Subscription"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      Protocol: "lambda"
      TopicArn: !GetAtt SNSTopicBracketSync.TopicArn
      Endpoint: !GetAtt LambdaBracketUpdateScoreboard.Arn
  SNSTriggerPermissionBracketSync:
    Type: "AWS::Lambda::Permission"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      FunctionName: !GetAtt LambdaBracketUpdateScoreboard.Arn
      Action: "lambda:InvokeFunction"
      SourceArn: !GetAtt SNSTopicBracketSync.TopicArn
      Principal: "sns.amazonaws.com"
  RoleBracketReadWrite:
    Type: "AWS::IAM::Role"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      Path: "/"
      ManagedPolicyArns:
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      - !GetAtt PolicyBracketReadWrite.PolicyArn
      - !GetAtt PolicyBracketPublish.PolicyArn
      MaxSessionDuration: 3600
      RoleName: !Sub "role-lambda-${LambdaReadWritePermissionName}"
      Description: ""
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
  RoleBracketRead:
    Type: "AWS::IAM::Role"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      Path: "/"
      ManagedPolicyArns:
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      - !GetAtt PolicyBracketRead.PolicyArn
      MaxSessionDuration: 3600
      RoleName: !Sub "role-lambda-${LambdaReadPermissionName}"
      Description: ""
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
  RoleBracketAdminRead:
    Type: "AWS::IAM::Role"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      Path: "/"
      ManagedPolicyArns:
      - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      - !GetAtt PolicyBracketAdminRead.PolicyArn
      MaxSessionDuration: 3600
      RoleName: !Sub "role-lambda-${LambdaAdminReadPermissionName}"
      Description: "Allows admin auth function to read ssm secret"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "lambda.amazonaws.com"
  PolicyBracketReadWrite:
    Type: "AWS::IAM::ManagedPolicy"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      ManagedPolicyName: !Sub "policy-lambda-${LambdaReadWritePermissionName}"
      Path: "/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Resource:
          - !GetAtt S3BracketPrivate.Arn
          - !Sub "${S3BracketPrivate.Arn}/*"
          Action:
          - "s3:PutObject"
          - "s3:GetObject"
          - "s3:DeleteObject"
          - "s3:ListBucket"
          Effect: "Allow"
          Sid: "VisualEditor0"
  PolicyBracketPublish:
    Type: "AWS::IAM::ManagedPolicy"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      ManagedPolicyName: !Sub "policy-lambda-${LambdaPublishPermissionName}"
      Path: "/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Resource:
          - !GetAtt SNSTopicBracketEmail.TopicArn
          - !GetAtt SNSTopicBracketSync.TopicArn
          Action:
          - "sns:Publish"
          Effect: "Allow"
          Sid: "VisualEditor0"
  PolicyBracketRead:
    Type: "AWS::IAM::ManagedPolicy"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      ManagedPolicyName: !Sub "policy-lambda-${LambdaReadPermissionName}"
      Path: "/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Resource:
          - !GetAtt S3BracketPrivate.Arn
          - !Sub "${S3BracketPrivate.Arn}/*"
          Action:
          - "s3:GetObject"
          - "s3:ListBucket"
          Effect: "Allow"
          Sid: "VisualEditor0"
  PolicyBracketAdminRead:
    Type: "AWS::IAM::ManagedPolicy"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      ManagedPolicyName: !Sub "policy-lambda-${LambdaAdminReadPermissionName}"
      Path: "/"
      Description: ""
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${SsmAdminSecretId}"
          Action: "ssm:GetParameter"
          Effect: "Allow"
          Sid: "VisualEditor0"
  S3BracketPublic:
    Type: "AWS::S3::Bucket"
    UpdateReplacePolicy: "Retain"
    DeletionPolicy: "Delete"
    Properties:
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        BlockPublicAcls: true
      BucketName: !Ref PublicBucketName 
      OwnershipControls:
        Rules:
        - ObjectOwnership: "BucketOwnerEnforced" 
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - BucketKeyEnabled: false
          ServerSideEncryptionByDefault:
            SSEAlgorithm: "AES256"
  S3BracketPrivate:
    Type: "AWS::S3::Bucket"
    UpdateReplacePolicy: "Retain"
    DeletionPolicy: "Delete"
    Properties:
      PublicAccessBlockConfiguration:
        RestrictPublicBuckets: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        BlockPublicAcls: true
      BucketName: !Ref PrivateBucketName 
      OwnershipControls:
        Rules:
        - ObjectOwnership: "BucketOwnerEnforced"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - BucketKeyEnabled: false
          ServerSideEncryptionByDefault:
            SSEAlgorithm: "AES256"
  S3BucketPolicyBracket:
    Type: "AWS::S3::BucketPolicy"
    UpdateReplacePolicy: "Retain"
    DeletionPolicy: "Delete"
    Properties:
      Bucket: !Ref S3BracketPublic
      PolicyDocument:
        Version: "2008-10-17"
        Statement:
        - Condition:
            StringEquals:
              AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/EAYYH2TLICFBU"  #SUB
          Resource: !Sub "${S3BracketPublic.Arn}/*"
          Action: "s3:GetObject"
          Effect: "Allow"
          Principal:
            Service: "cloudfront.amazonaws.com"
          Sid: "AllowCloudFrontServicePrincipal"
        Id: "PolicyForCloudFrontPrivateContent"
  LogBracketLambdaAddElement:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaAddElementName}"
      RetentionInDays: 7
  LogBracketLambdaAdminAuth:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaAdminAuthName}"
      RetentionInDays: 7
  LogBracketLambdaAdminEdit:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaAdminEditName}"
      RetentionInDays: 7
  LogBracketLambdaGetBracket:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaGetBracketName}"
      RetentionInDays: 7
  LogBracketLambdaGetCompetitions:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaGetCompetitionsName}"
      RetentionInDays: 7
  LogBracketLambdaGetRoundStart:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaGetRoundStartName}"
      RetentionInDays: 7
  LogBracketLambdaGetScoreboard:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaGetScoreboardName}"
      RetentionInDays: 7
  LogBracketLambdaSendEmail:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaSendEmailName}"
      RetentionInDays: 7
  LogBracketLambdaUpdatePicks:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaUpdatePicksName}"
      RetentionInDays: 7
  LogBracketLambdaUpdateScoreboard:
    Type: "AWS::Logs::LogGroup"
    UpdateReplacePolicy: "Delete"
    DeletionPolicy: "Delete"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LambdaUpdateScoreboardName}"
      RetentionInDays: 7


